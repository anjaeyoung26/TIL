# 프로세스와 쓰레드

## 프로세스

프로세스란 실행 중인 프로그램을 뜻한다. 디스크로부터 메모리에 적재되어 CPU를 할당받는다. OS는 프로세스에게 **주소 공간, 파일, 메모리**를 할당하고 프로세스 제어 블록(PCB)를 생성한다. 

프로세스 제어 블록은 프로세스에 대한 정보를 갖는 OS의 자료구조이다. 프로세스는 CPU를 할당받아 작업을 처리하던 중 프로세스 전환이 발생하면 CPU를 반환해야 하는데 이때 진행하던 작업을 PCB에 저장하고, 이후 다시 CPU를 할당받아 작업을 할 때 가져온다.

<p align="center">
    <img src="https://user-images.githubusercontent.com/61190690/166910077-6c4fa316-1b58-411c-916c-de0623bb67d1.png">
</p>

- 가변 영역 : 입력 값에 의한 함수의 호출 횟수나 동적으로 생성되는 변수들의 크기는 가변적이며, 이는 런타임 시 결정된다. **스택**은 함수의 매개 변수, 복귀 주소, 로컬 변수와 같은 임시 데이터가 저장되며, **힙**은 프로세스 실행 중 동적으로 생성되는 데이터가 저장된다.

- 고정 영역 : 값이 변하지 않는 전역 변수나 코드는 컴파일 시 결정된다. **데이터** 영역은 전역 변수, 전역 변수가 저장되며 **텍스트** 영역은 컴파일된 소스 코드가 저장된다.

&nbsp;
## 쓰레드

한 프로세스 내에서 동작되는 여러 실행의 흐름으로, 프로세스 내의 주소 공간이나 자원을 공유한다.

<p align="center">
    <img src="https://user-images.githubusercontent.com/61190690/166910089-12acaa36-823a-4111-9521-2f971f161dec.png">
</p>

- 공유 영역 : 쓰레드는 자신이 속한 프로세스의 `code`, `data`, `heap` 영역을 공유한다.

    > **왜 스택은 하나씩 가지고 있을까?** : 스택은 함수의 매개 변수, 복귀 주소, 함수 내에서 선언하는 변수 등을 저장하기 위해 사용되는 메모리 공간이다. 각 쓰레드는 자신의 스택에서 함수를 호출하여 독립적인 실행 흐름을 추가한다. 따라서 쓰레드의 정의에 따라 독립적인 실행 흐름을 추가하기 위한 최소 조건으로 독립된 스택을 할당한다.

    > **왜 PC 레지스터는 하나씩 가지고 있을까?** : PC 레지스터는 명령어를 어디까지 수행했는지를 나타낸다. 스택은 스케쥴러에 의해 할당받은 CPU를 반환했다가 다시 선점할 경우 PC 레지스터의 값을 통해 명령어를 이어서 수행한다.

- 독립 영역은 스택과 PC 레지스터가 존재한다. **스택**은 독립적인 작업을 수행하기 위한 메모리 영역이며, **PC 레지스터**는 명령어의 어디까지 수행했는지 나타낸다.


&nbsp;
# 멀티 쓰레딩

일반적으로 프로세스에서 하나의 쓰레드를 통해 작업을 수행하는 것과 달리, 둘 이상의 쓰레드가 동시에 작업을 수행한다.

<p align="center">
    <img src="https://user-images.githubusercontent.com/61190690/166910096-90e1b16c-43ff-4de7-a8f7-2466292c0b27.png">
</p>


## 장점

각 쓰레드는 자신이 속한 프로세스의 `code`, `data`, `heap` 영역을 공유하므로 메모리 공간과 시스템 자원의 소모가 줄어든다. 따라서 Context Switching의 비용이 줄어든다. 부모 프로세스가 자식 프로세스를 생성하면 모든 영역이 독립적으로 생성되므로 프로세스간 통신을 하기 위해서는 IPC(Inter Process Communication)가 필요하다. 

> **Context Switching** : CPU가 실행 중인 프로세스나 쓰레드를 교체할 때, 실행 중인 프로세스나 쓰레드에 대한 정보(Context)를 PCB에 저장하고 교체할 프로세스에 대한 정보를 메모리에 올리는 작업

하지만 멀티 쓰레딩에서는 쓰레드를 추가하면 부모 프로세스의 `code`, `data`, `heap` 영역을 공유하기 때문에 쓰레드 간 Context Switching이 간단하며 쓰레드의 Context Switch는 프로세스와 달리 캐시 메모리를 비우지 않아도 되기 때문에 자원의 소모가 적다. 또한 사용자 입장에서 프로그램이 Interactive 하게 느껴진다. 하나의 쓰레드가 입/출력으로 인해 Block 되어도 다른 쓰레드는 계속 작업을 수행한다.

&nbsp;
## 단점

각 쓰레드가 자신이 속한 프로세스의 `code`, `data`, `heap` 영역을 공유하므로 이미 다른 쓰레드가 사용 중인 변수나 자료구조에 접근할 수 있다. 또한 동기화 작업을 통해 작업 순서와 공유 자원에 대한 접근을 컨트롤 해야한다. 하지만 이로 인해 병목현상이 발생해 성능이 저하될 가능성이 높다.

&nbsp;
## vs 멀티 프로세스

멀티 쓰레드는 멀티 프로세스보다 적은 메모리 공간을 차지하고 Context Switching이 빠르다는 장점이 있지만, 오류로 인해 하나의 쓰레드가 종료되면 전체 스레드가 종료될 수 있다는 점과 동기화 문제를 안고 있다. 

반면 멀티 프로세스 방식은 하나의 프로세스가 죽더라도 다른 프로세스에는 영향을 끼치지 않고 정상적으로 수행된다는 장점이 있지만, 멀티 스레드보다 많은 메모리 공간과 CPU 시간을 차지한다는 단점이 존재한다. 이 두 가지는 동시에 여러 작업을 수행한다는 점에서 같지만 적용해야 하는 시스템에 따라 적합/부적합이 구분된다. 따라서 대상 시스템의 특징에 따라 적합한 동작 방식을 선택하고 적용해야 한다.