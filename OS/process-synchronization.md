# 프로세스 동기화

멀티 쓰레딩 환경에서는 부모 프로세스의 자원을 모든 쓰레드가 공유하므로 한 쓰레드가 사용 중인 자원을 다른 쓰레드가 접근할 수 있기 때문에 동기화가 필요하다. 

## Race Condition

멀티 쓰레드(혹은 프로세스) 환경에서 두 개 이상의 쓰레드가 공유 자원을 동시에 접근을 시도할 때 타이밍, 순서 등의 결과값에 영향을 줄 수 있는 상태이다. 이를 해결하기 위해 임계 영역(Critical Section)을 적절히 설계한다.

&nbsp;
## 임계 영역

임계 영역(Critical Section)이란 **한 자원을 동시에 접근하는 작업이 실행되는 코드 영역**이다. 임계 영역으로 지정되어야 할 코드 영역이 임계 영역으로 지정되지 않았을 때 발생할 수 있는 문제를 **임계 영역 문제**라고 한다. 임계 영역 문제를 해결하기 위해서는 세 가지 조건을 충족해야 한다.

1. **상호 배제(Mutual Exclusion)** : 하나의 프로세스가 임계 영역에 들어가 있다면, 다른 프로세스는 들어갈 수 없어야 한다.
2. **진행(Progress)** : 임계 영역에서 실행 중인 프로세스가 없을 때, 다른 프로세스가 적절히 들어갈 수 있게 해야한다.
3. **한정 대기(Bounded Waiting)** : 다른 프로세스의 기아(Starvation)를 방지하기 위해, 한 번 임계 영역에 들어간 프로세스는 다음 번 임계 구역에 들어갈 때 제한을 두어야 한다.

&nbsp;
### 임계 영역 문제를 해결하는 방식

1. **Busy - Wait** : 공유 자원이 모두 사용 중이라면, 프로세스나 쓰레드가 자원을 사용할 수 있을 때까지 Wait 한다. 계속해서 반복문을 실행하므로 효율이 좋지 않고 대기 중인 프로세스나 쓰레드 간 진입 순서가 보장되지 않는다.

    > Busy Waiting : 원하는 자원을 얻을 때 까지 반복해서 확인하는 동기화 방식

2. **Block - Wakeup** : `Busy Waiting`을 해결하기 위한 방식으로 공유 자원이 모두 사용 중이라면, 프로세스나 쓰레드를 Block 시키고 `Wait Queue`에 추가한다. 다른 프로세스나 쓰레드가 작업을 끝내 자원을 사용할 수 있다면 `Wait Queue`에 있는 프로세스나 쓰레드를 `Wait Queue`에서 제거하고 `Ready Queue`에 추가하고 스케줄러가 스케줄링을 수행한다.

    > 임계 영역의 길이가 매우 짧은 경우에는 `Block - Wakeup` 방식은 오히려 오버헤드가 커질 수 있다. 하지만 일반적으로는 더 좋음..

&nbsp;
## **세마포어(Semaphore)**

임계 영역에 진입할 수 있는 프로세스의 갯수를 나타내는 정수 값의 변수이다. 아래는 세마포어의 핵심 세 가지이다.

1. **S(세마포어 변수)** : 세마포어 자체를 의미하는 정수 값의 변수이며 P∙T 연산으로 값을 증감한다.
2. **P(try)** : 프로세스가 임계 구역 진입 시 수행된다. S의 값이 0보다 크면 접근을 허용하고 1 만큼 감소시킨다.
3. **V(increment)** : 프로세스가 임계 구역에서 작업을 끝낸 뒤 수행된다. S의 값을 1 만큼 증가시킨다.
    > P, V 연산은 모두 원자성(Atomic)을 만족해야 한다. 하나의 프로세스나 쓰레드에서 S의 값을 변경하는 동안 다른 프로세스나 쓰레드에서 동시에 접근해서 변경할 수 없다.

### **종류**

1. **이진 세마포어** : S의 값을 1로 초기화하여 범위를 0과 1로 제한한다. 동시에 접근할 수 있는 자원이 갯수가 한 개일 경우 사용된다.
    
    ![binary-semaphore](https://user-images.githubusercontent.com/61190690/166910108-aed3d133-05cd-41a6-b681-7b637484342e.png)
    
2. **카운팅 세마포어** : S의 값을 동시에 접근할 수 있는 자원의 갯수로 초기화하며 범위에 제약이 없다. 유한한 갯수를 가진 자원에 대한 접근 제어용으로 사용된다.

### **단점**

세마포어는 교착상태가 발생할 수 있다. **서로 다른 프로세스가 서로에 의해 충족되는 이벤트를 무한정 기다리는 상태**이다. 

프로세스 P1, P2는 세마포어 S, Q를 모두 획득해야 작업을 진행할 수 있다. 먼저 P1이 S를 획득하고 이어서 P2가 Q를 획득했다면 P1과 P2는 나머지 자원을 얻기위해 서로를 무한정 기다리는 상태가 된다.
    
> 세마포어 타임아웃으로 해결 : 일정 시간이 지났음에도 불구하고 필요한 세마포어가 모두 획득이 되지 않을 경우 가지고 있는 세마포어를 모두 반환한다.

&nbsp;
## 스핀 락(Spin Lock)

획득(`Lock`) 또는 해제(`Unlock`)을 통해 공유 자원에 대한 접근 권한을 관리하는 방법이다. 권한을 획득하기 전까지 `Busy - Waiting` 상태였다가 접근 권한을 얻게 되면 코드를 수행하고, 종료 후 권한을 해제한다. 이진 세마포어와 마찬가지로 `Lock`, `Unlock` 두 가지 상태밖에 없어서 하나의 프로세스나 쓰레드만 공유 자원에 접근할 수 있다.

- 장점 : 하나의 작업이 빠르게 수행된다.
- 단점 : 선점 기간 동안에는 다른 프로세스나 쓰레드가 지연될 수 있는 오버헤드가 존재한다.

&nbsp;
## 뮤텍스(Mutex)

Mutual Exclusion으로 상호 배제라고도 한다. 스핀 락과 마찬가지로 `Lock`, `Unlock` 상태가 있지만, 스핀 락과 다르게 접근 권한을 획득할 때 까지 `Busy - Waiting` 하지 않고 `Block - Wakeup` 방식을 사용한다.

### vs 세마포어

카운팅 세마포어 같은 경우 동기화 대상이 여러개일 경우, 뮤텍스는 이진 세마포어와 같이 동기화 대상이 하나일 경우 사용한다.